<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard | Zetech E-Voting</title>
<style>
:root {
  --primary:#0F2A44;
  --primary-light:#163A5F;
  --background:#F5F7FA;
  --white:#fff;
  --muted:#6B7280;
  --shadow:rgba(0,0,0,.1);
  --winner:#22C55E;
}
* { box-sizing:border-box; font-family:"Segoe UI",Arial,sans-serif; }
body{background:var(--background); margin:0; min-height:100vh;}
header{background:var(--primary); color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center;}
header h1{font-size:1.2rem;}
header button{background:none; border:none; color:#fff; cursor:pointer; font-weight:600;}
main{padding:1rem; max-width:900px; margin:auto;}
section{margin-bottom:1.5rem;}
section h2{color:var(--primary); margin-bottom:.5rem;}
.card{background:var(--white); padding:1rem; border-radius:12px; box-shadow:0 4px 12px var(--shadow); margin-bottom:.8rem;}
.card h3{margin:0 0 .3rem 0; color:#111827;}
.card p{margin:2px 0; color:var(--muted); font-size:.9rem;}
.card button{margin-top:.5rem; padding:.6rem; border:none; border-radius:8px; background:var(--primary); color:#fff; font-weight:600; cursor:pointer;}
.card button:hover{background:var(--primary-light);}
.vote-info{margin-top:.3rem; font-size:0.85rem; color:var(--muted);}
.vote-info ul{margin:0.2rem 0 0 1.2rem; padding:0;}
.vote-info ul li{margin:0.1rem 0;}
.winner-label{margin-top:.5rem; font-weight:600; color:var(--winner);}
textarea{width:100%; padding:.6rem; margin-top:.3rem; border-radius:8px; border:1px solid #ccc;}
.send-btn{background:#0F2A44; color:#fff; font-weight:600; margin-top:.5rem; width:100%; cursor:pointer; padding:.6rem; border:none; border-radius:8px;}
.send-btn:hover{background:var(--primary-light);}
.exit-btn{background:#8B0000; color:#fff; font-weight:600; margin-top:.5rem; width:100%; cursor:pointer; padding:.6rem; border:none; border-radius:8px;}
.exit-btn:hover{background:#b22222;}
</style>
</head>
<body>

<header>
  <h1>Student Dashboard</h1>
  <button onclick="logout()">Exit</button>
</header>

<main>

  <!-- Active Elections -->
  <section>
    <h2>Active Elections</h2>
    <div id="activeElectionsContainer">Loading active elections...</div>
  </section>

  <!-- Results Section -->
  <section>
    <h2>Election Results</h2>
    <label for="resultsElectionSelect">Select Election:</label>
    <select id="resultsElectionSelect"></select>
    <div id="resultsContainer">Select an election to view results.</div>
  </section>

  <!-- Send Message Section -->
  <section>
    <h2>Send Message</h2>
    <textarea id="messageText" rows="3" placeholder="Type your message here..."></textarea>
    <button class="send-btn" onclick="sendMessage()">Send Message</button>
  </section>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ----------------- Auth Check & Logout -----------------
if(localStorage.getItem("studentLoggedIn")!=="true"){ window.location.href="signin.html"; }

window.logout = () => {
  localStorage.removeItem("studentLoggedIn");
  localStorage.removeItem("studentDocId");
  localStorage.removeItem("studentFullName");
  window.location.href = "signin.html";
};

// ----------------- Active Elections -----------------
const activeContainer = document.getElementById("activeElectionsContainer");
async function loadActiveElections(){
  activeContainer.innerHTML = "";
  try{
    const q = query(collection(db,"elections"), where("status","==","active"));
    const snap = await getDocs(q);
    if(snap.empty){ activeContainer.innerHTML="<p>No active elections at the moment.</p>"; return; }
    snap.forEach(docu=>{
      const e = docu.data();
      const start = e.startAt?.toDate ? e.startAt.toDate().toLocaleDateString() : e.startAt;
      const end = e.endAt?.toDate ? e.endAt.toDate().toLocaleDateString() : e.endAt;
      const card = document.createElement("div");
      card.className="card";
      card.innerHTML = `
        <h3>${e.name}</h3>
        <p>Period: ${start} â†’ ${end}</p>
        <p>Status: ACTIVE</p>
        <button onclick="vote('${docu.id}')">Vote Now</button>
      `;
      activeContainer.appendChild(card);
    });
  }catch(err){
    console.error(err);
    activeContainer.innerHTML="<p>Error loading elections.</p>";
  }
}
window.vote = (electionId)=>{ window.location.href=`vote.html?electionId=${electionId}`; };
await loadActiveElections();

// ----------------- Results Section -----------------
const resultsSelect = document.getElementById("resultsElectionSelect");
const resultsContainer = document.getElementById("resultsContainer");

async function loadElectionOptions(){
  resultsSelect.innerHTML = "<option value=''>-- Select Election --</option>";
  const snap = await getDocs(collection(db,"elections"));
  snap.forEach(docu=>{
    resultsSelect.innerHTML += `<option value="${docu.id}">${docu.data().name}</option>`;
  });
}
resultsSelect.onchange = ()=> loadResults(resultsSelect.value);
await loadElectionOptions();

async function loadResults(electionId){
  resultsContainer.innerHTML = "Loading results...";
  if(!electionId){ resultsContainer.innerHTML="<p>Select an election to view results.</p>"; return; }

  try{
    const positionsSnap = await getDocs(collection(db, `elections/${electionId}/positions`));
    if(positionsSnap.empty){ resultsContainer.innerHTML="<p>No positions found.</p>"; return; }
    resultsContainer.innerHTML = "";

    for(const posDoc of positionsSnap.docs){
      const pos = posDoc.data();
      const posCard = document.createElement("div");
      posCard.className="card";
      posCard.innerHTML = `<h3>${pos.title} (${pos.department})</h3>`;
      resultsContainer.appendChild(posCard);

      const candidatesSnap = await getDocs(collection(db, `elections/${electionId}/positions/${posDoc.id}/candidates`));
      if(candidatesSnap.empty){ posCard.innerHTML += "<p>No candidates.</p>"; continue; }

      let winner = null;
      let maxVotes = -1;
      const candidateCards = [];

      for(const cDoc of candidatesSnap.docs){
        const c = cDoc.data();
        const votes = c.votes || 0;
        if(votes > maxVotes){ maxVotes = votes; winner = c; }

        const card = document.createElement("div");
        card.className="candidate-card";
        card.innerHTML = `<span>${c.fullName} (${c.admissionNumber}) - Votes: ${votes}</span>`;

        const votedByList = c.votedBy || [];
        const voteInfo = document.createElement("div");
        voteInfo.className = "vote-info";
        if(votedByList.length === 0){ voteInfo.textContent="No votes yet."; }
        else{
          voteInfo.innerHTML = "<strong>Voters:</strong>";
          const ul = document.createElement("ul");
          for(const studentId of votedByList){
            const studentSnap = await getDoc(doc(db,"Students",studentId));
            const student = studentSnap.exists() ? studentSnap.data() : { fullName: studentId };
            const li = document.createElement("li");
            li.textContent = student.fullName;
            ul.appendChild(li);
          }
          voteInfo.appendChild(ul);
        }
        card.appendChild(voteInfo);
        candidateCards.push(card);
      }

      candidateCards.forEach(card=> posCard.appendChild(card));
      if(winner){
        const winnerDiv = document.createElement("div");
        winnerDiv.className = "winner-label";
        winnerDiv.textContent = `Winner: ${winner.fullName} (${winner.admissionNumber}) with ${winner.votes} votes`;
        posCard.appendChild(winnerDiv);
      }
    }

  }catch(err){ console.error(err); resultsContainer.innerHTML="<p>Error loading results.</p>"; }
}

// ----------------- Messaging -----------------
window.sendMessage = async ()=>{
  const msg = document.getElementById("messageText").value.trim();
  if(!msg){ alert("Enter a message."); return; }

  try{
    const studentId = localStorage.getItem("studentDocId");
    const studentName = localStorage.getItem("studentFullName") || "Anonymous";

    await addDoc(collection(db,"messages"),{
      senderId: studentId,
      senderName: studentName,
      text: msg,
      createdAt: serverTimestamp(),
      read: false
    });

    alert("Message sent!");
    document.getElementById("messageText").value = "";
  }catch(err){
    console.error(err);
    alert("Error sending message.");
  }
};
</script>
</body>
</html>
