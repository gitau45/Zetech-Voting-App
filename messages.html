<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Messages | Zetech E-Voting</title>
<style>
:root {
  --primary:#0F2A44;
  --primary-light:#163A5F;
  --background:#F5F7FA;
  --white:#fff;
  --muted:#6B7280;
  --shadow:rgba(0,0,0,.1);
  --unread:#FDE68A;
}
* { box-sizing:border-box; font-family:"Segoe UI",Arial,sans-serif; }
body{background:var(--background); margin:0; min-height:100vh;}
header{background:var(--primary); color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center;}
header h1{font-size:1.2rem;}
header button{background:none; border:none; color:#fff; cursor:pointer; font-weight:600; margin-left:0.5rem;}
main{padding:1rem; max-width:900px; margin:auto;}
.back-btn{margin-bottom:1rem; padding:.5rem 1rem; border:none; border-radius:6px; background:#6B7280; color:#fff; cursor:pointer;}
.back-btn:hover{background:#4B5563;}
.message-card{background:var(--white); padding:1rem; border-radius:12px; box-shadow:0 4px 12px var(--shadow); margin-bottom:.8rem;}
.message-card.unread{background:var(--unread);}
.message-card h4{margin:0 0 .3rem 0; color:#111827;}
.message-card p{margin:2px 0; color:var(--muted);}
.message-card small{display:block; margin-top:.3rem; color:#6B7280; font-size:.8rem;}
.admin-reply{margin-top:.3rem; padding:.4rem .6rem; background:#E0F2FE; border-radius:6px; font-size:0.85rem; color:#0F2A44;}
</style>
</head>
<body>

<header>
  <h1>Student Messages</h1>
  <div>
    <button onclick="logout()">Exit</button>
  </div>
</header>

<main>
  <!-- Back to Admin Dashboard -->
  <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>

  <h2>All Messages</h2>
  <div id="messagesContainer">Loading messages...</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Logout
window.logout = ()=>{ window.location.href="admin-dashboard.html"; };

// Back button function
function goBack(){
  window.location.href = "admin-dashboard.html";
}

const container = document.getElementById("messagesContainer");

// Load messages with student names
async function loadMessages(){
  container.innerHTML = "Loading messages...";
  try{
    const q = query(collection(db,"messages"), orderBy("createdAt","desc"));
    const snap = await getDocs(q);
    if(snap.empty){ container.innerHTML="<p>No messages yet.</p>"; return; }

    container.innerHTML = "";
    for(const docu of snap.docs){
      const m = docu.data();
      let senderName = "Unknown";

      // Fetch student name
      if(m.senderId){
        const studentSnap = await getDoc(doc(db,"Students",m.senderId));
        if(studentSnap.exists()){
          senderName = studentSnap.data().fullName;
        }
      }

      const div = document.createElement("div");
      div.className = "message-card";
      if(!m.read) div.classList.add("unread");
      const time = m.createdAt ? m.createdAt.toDate().toLocaleString() : "Unknown time";

      div.innerHTML = `
        <h4>From: ${senderName}</h4>
        <p>${m.text}</p>
        <small>Sent at: ${time}</small>
      `;

      // Show admin reply if exists
      if(m.adminReply){
        const replyDiv = document.createElement("div");
        replyDiv.className = "admin-reply";
        replyDiv.textContent = `Admin Reply: ${m.adminReply}`;
        div.appendChild(replyDiv);
      }

      container.appendChild(div);
    }
  }catch(err){
    console.error(err);
    container.innerHTML = "<p>Error loading messages.</p>";
  }
}

await loadMessages();
</script>

</body>
</html>
