<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Election Tally | Zetech E-Voting</title>
<style>
:root {
  --primary:#0F2A44;
  --primary-light:#163A5F;
  --background:#F5F7FA;
  --white:#fff;
  --muted:#6B7280;
  --shadow:rgba(0,0,0,.1);
  --winner:#22C55E;
}
* { box-sizing:border-box; font-family:"Segoe UI",Arial,sans-serif; }
body{background:var(--background); margin:0; min-height:100vh;}
header{background:var(--primary); color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center;}
header h1{font-size:1.2rem;}
header button{background:none; border:none; color:#fff; cursor:pointer; font-weight:600; margin-left:0.5rem;}
main{padding:1rem;}
.back-btn{margin-bottom:1rem; padding:.5rem 1rem; border:none; border-radius:6px; background:#6B7280; color:#fff; cursor:pointer;}
.back-btn:hover{background:#4B5563;}
.position-card{background:var(--white); padding:1rem; border-radius:12px; box-shadow:0 4px 12px var(--shadow); margin-bottom:1rem;}
.position-card h3{margin:0 0 .5rem 0;}
.candidate-card{display:flex; justify-content:space-between; align-items:flex-start; padding:.5rem .8rem; margin-bottom:.3rem; border-radius:8px; background:#F9FAFB; flex-direction:column;}
.candidate-card span{font-weight:500;}
.vote-info{margin-top:.3rem; font-size:0.85rem; color:var(--muted);}
.vote-info ul{margin:0.2rem 0 0 1.2rem; padding:0;}
.vote-info ul li{margin:0.1rem 0;}
select{margin-bottom:1rem; padding:.5rem; width:100%;}
.winner-label{margin-top:.5rem; font-weight:600; color:var(--winner);}
</style>
</head>
<body>

<header>
  <h1>Election Tally</h1>
  <div>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<main>
  <!-- Back Button -->
  <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>

  <h2>Results</h2>
  <div id="electionSelectContainer">
    <label>Select Election:</label>
    <select id="electionSelect"></select>
  </div>
  <div id="tallyContainer">Loading results...</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Auth check
if(localStorage.getItem("studentLoggedIn")!=="true"){ window.location.href="signin.html"; }

const container = document.getElementById("tallyContainer");
const electionSelect = document.getElementById("electionSelect");

// Logout
window.logout = ()=>{ localStorage.clear(); window.location.href="signin.html"; };

// Back button
function goBack(){
  window.location.href = "admin-dashboard.html";
}

// Load all elections into dropdown
async function loadElections(){
  electionSelect.innerHTML = "<option value=''>-- Select Election --</option>";
  const snap = await getDocs(collection(db,"elections"));
  snap.forEach(docu=>{
    electionSelect.innerHTML += `<option value="${docu.id}">${docu.data().name}</option>`;
  });
}
electionSelect.onchange = ()=> loadResults(electionSelect.value);
await loadElections();

// Load results with winner
async function loadResults(electionId){
  container.innerHTML = "Loading results...";
  if(!electionId){ container.innerHTML = "<p>Please select an election.</p>"; return; }

  try{
    const positionsSnap = await getDocs(collection(db, `elections/${electionId}/positions`));
    if(positionsSnap.empty){
      container.innerHTML="<p>No positions found for this election.</p>";
      return;
    }

    container.innerHTML = "";

    for(const posDoc of positionsSnap.docs){
      const pos = posDoc.data();
      const posCard = document.createElement("div");
      posCard.className="position-card";
      posCard.innerHTML=`<h3>${pos.title} (${pos.department})</h3>`;
      container.appendChild(posCard);

      const candidatesSnap = await getDocs(collection(db, `elections/${electionId}/positions/${posDoc.id}/candidates`));
      if(candidatesSnap.empty){
        const p = document.createElement("p");
        p.textContent="No candidates.";
        posCard.appendChild(p);
      } else {
        let winner = null;
        let maxVotes = -1;
        const candidateCards = [];

        // Build candidate cards and determine winner
        for(const cDoc of candidatesSnap.docs){
          const c = cDoc.data();
          const votes = c.votes || 0;
          if(votes > maxVotes){
            maxVotes = votes;
            winner = c;
          }

          const card = document.createElement("div");
          card.className="candidate-card";
          card.innerHTML = `<span>${c.fullName} (${c.admissionNumber}) - Votes: ${votes}</span>`;

          const votedByList = c.votedBy || [];
          const voteInfo = document.createElement("div");
          voteInfo.className = "vote-info";

          if(votedByList.length === 0){
            voteInfo.textContent = "No votes yet.";
          } else {
            voteInfo.innerHTML = "<strong>Voters:</strong>";
            const ul = document.createElement("ul");
            for(const studentId of votedByList){
              const studentSnap = await getDoc(doc(db,"Students",studentId));
              const student = studentSnap.exists() ? studentSnap.data() : { fullName: studentId };
              const li = document.createElement("li");
              li.textContent = student.fullName;
              ul.appendChild(li);
            }
            voteInfo.appendChild(ul);
          }

          card.appendChild(voteInfo);
          candidateCards.push(card);
        }

        // Append candidate cards
        candidateCards.forEach(card=> posCard.appendChild(card));

        // Show winner
        if(winner){
          const winnerDiv = document.createElement("div");
          winnerDiv.className = "winner-label";
          winnerDiv.textContent = `Winner: ${winner.fullName} (${winner.admissionNumber}) with ${winner.votes} votes`;
          posCard.appendChild(winnerDiv);
        }
      }
    }

  } catch(err){
    console.error(err);
    container.innerHTML="<p>Error loading results.</p>";
  }
}
</script>

</body>
</html>
