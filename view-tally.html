<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Election Tally | Zetech E-Voting</title>

<style>
:root {
  --primary:#0F2A44;
  --background:#F5F7FA;
  --white:#fff;
  --muted:#6B7280;
  --shadow:rgba(0,0,0,.1);
  --winner:#22C55E;
}
*{box-sizing:border-box;font-family:"Segoe UI",Arial,sans-serif}
body{margin:0;background:var(--background)}
header{background:var(--primary);color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center}
header h1{font-size:1.2rem}
header button{background:none;border:none;color:#fff;font-weight:600;cursor:pointer}
main{padding:1rem;max-width:1000px;margin:auto}

.back-btn{
  margin-bottom:1rem;
  padding:.5rem 1rem;
  border:none;
  border-radius:6px;
  background:#6B7280;
  color:#fff;
  cursor:pointer
}
.back-btn:hover{background:#4B5563}

.position-card{
  background:var(--white);
  padding:1rem;
  border-radius:12px;
  box-shadow:0 4px 12px var(--shadow);
  margin-bottom:1rem
}
.candidate-card{
  background:#F9FAFB;
  padding:.6rem;
  border-radius:8px;
  margin-bottom:.4rem
}
.vote-info{font-size:.85rem;color:var(--muted)}
.winner-label{margin-top:.6rem;font-weight:600;color:var(--winner)}
select{width:100%;padding:.5rem;margin-bottom:1rem}
</style>
</head>

<body>

<header>
  <h1>Election Tally (Admin)</h1>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <button class="back-btn" onclick="goBack()">← Back to Admin Dashboard</button>

  <h2>Election Results</h2>

  <label>Select Election:</label>
  <select id="electionSelect"></select>

  <div id="tallyContainer">Loading results...</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= ADMIN AUTH CHECK ================= */
if (localStorage.getItem("adminLoggedIn") !== "true") {
  window.location.href = "admin-login.html";
}

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= UI ================= */
const electionSelect = document.getElementById("electionSelect");
const container = document.getElementById("tallyContainer");

window.logout = () => {
  localStorage.removeItem("adminLoggedIn");
  localStorage.removeItem("adminEmail");
  window.location.href = "admin-login.html";
};

window.goBack = () => {
  window.location.href = "admin-dashboard.html";
};

/* ================= LOAD ELECTIONS ================= */
async function loadElections(){
  electionSelect.innerHTML = "<option value=''>-- Select Election --</option>";
  const snap = await getDocs(collection(db,"elections"));
  snap.forEach(docu=>{
    electionSelect.innerHTML += `<option value="${docu.id}">${docu.data().name}</option>`;
  });
}
await loadElections();

electionSelect.onchange = () => loadResults(electionSelect.value);

/* ================= LOAD RESULTS ================= */
async function loadResults(electionId){
  container.innerHTML = "Loading results...";
  if(!electionId){
    container.innerHTML = "<p>Please select an election.</p>";
    return;
  }

  const positionsSnap = await getDocs(
    collection(db,`elections/${electionId}/positions`)
  );

  if(positionsSnap.empty){
    container.innerHTML = "<p>No positions found.</p>";
    return;
  }

  container.innerHTML = "";

  for(const posDoc of positionsSnap.docs){
    const pos = posDoc.data();
    const posCard = document.createElement("div");
    posCard.className="position-card";
    posCard.innerHTML=`<h3>${pos.title} (${pos.department})</h3>`;
    container.appendChild(posCard);

    const candidatesSnap = await getDocs(
      collection(db,`elections/${electionId}/positions/${posDoc.id}/candidates`)
    );

    let winner=null,maxVotes=-1;

    for(const cDoc of candidatesSnap.docs){
      const c=cDoc.data();
      const votes=c.votes||0;

      if(votes>maxVotes){maxVotes=votes;winner=c}

      const card=document.createElement("div");
      card.className="candidate-card";
      card.innerHTML=`<strong>${c.fullName}</strong> (${c.admissionNumber}) — Votes: ${votes}`;

      const voters=c.votedBy||[];
      const info=document.createElement("div");
      info.className="vote-info";

      if(voters.length){
        const ul=document.createElement("ul");
        for(const sid of voters){
          const sSnap=await getDoc(doc(db,"Students",sid));
          const name=sSnap.exists()?sSnap.data().fullName:sid;
          const li=document.createElement("li");
          li.textContent=name;
          ul.appendChild(li);
        }
        info.appendChild(ul);
      }else{
        info.textContent="No votes yet.";
      }

      card.appendChild(info);
      posCard.appendChild(card);
    }

    if(winner){
      const win=document.createElement("div");
      win.className="winner-label";
      win.textContent=`Winner: ${winner.fullName} with ${winner.votes} votes`;
      posCard.appendChild(win);
    }
  }
}
</script>

</body>
</html>
