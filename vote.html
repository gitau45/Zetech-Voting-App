<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vote | Zetech E-Voting</title>
<style>
:root {
  --primary:#0F2A44;
  --primary-light:#163A5F;
  --background:#F5F7FA;
  --white:#fff;
  --muted:#6B7280;
  --shadow:rgba(0,0,0,.1);
}
* { box-sizing:border-box; font-family:"Segoe UI",Arial,sans-serif; }
body{background:var(--background); margin:0; min-height:100vh;}
header{background:var(--primary); color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center;}
header h1{font-size:1.2rem;}
header button{background:none; border:none; color:#fff; cursor:pointer; font-weight:600;}
main{padding:1rem;}
.back-btn{margin-bottom:1rem; padding:.5rem 1rem; border:none; border-radius:6px; background:var(--primary); color:#fff; cursor:pointer;}
.back-btn:hover{background:var(--primary-light);}
.position-card{background:var(--white); padding:1rem; border-radius:12px; box-shadow:0 4px 12px var(--shadow); margin-bottom:1rem;}
.position-card h3{margin:0 0 .5rem 0;}
.candidate-card{display:flex; justify-content:space-between; align-items:center; padding:.5rem .8rem; margin-bottom:.3rem; border-radius:8px; background:#F9FAFB;}
.candidate-card span{font-weight:500;}
.candidate-card button{padding:.4rem .8rem; border:none; border-radius:6px; background:var(--primary); color:#fff; cursor:pointer;}
.candidate-card button:hover{background:var(--primary-light);}
.candidate-card button:disabled{background:#A1A1AA; cursor:not-allowed;}
</style>
</head>
<body>

<header>
  <h1>Vote</h1>
  <button onclick="logout()">Logout</button>
</header>

<main>
  <!-- Back to Student Dashboard -->
  <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>

  <h2>Cast Your Vote</h2>
  <div id="candidatesContainer">Loading candidates...</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6sugBbX6kvd3RuwznAZkgHzAoEigpnj8",
  authDomain: "zetech-e-voting.firebaseapp.com",
  projectId: "zetech-e-voting"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Auth check
if(localStorage.getItem("studentLoggedIn")!=="true"){ window.location.href="signin.html"; }
const studentDocId = localStorage.getItem("studentDocId");
if(!studentDocId){ window.location.href="signin.html"; }

// Get electionId from URL
const urlParams = new URLSearchParams(window.location.search);
const electionId = urlParams.get("electionId");
if(!electionId){ document.getElementById("candidatesContainer").innerHTML="<p>No election selected.</p>"; }

const container = document.getElementById("candidatesContainer");

// Logout
window.logout = ()=>{ localStorage.clear(); window.location.href="signin.html"; };

// Back button function
function goBack(){
  window.location.href = "stdash.html";
}

// Load candidates grouped by position
async function loadCandidates(){
  container.innerHTML = "";

  try{
    const studentRef = doc(db, "Students", studentDocId);
    const studentSnap = await getDoc(studentRef);
    const student = studentSnap.data();
    const hasVoted = student.hasVoted || {};

    const positionsSnap = await getDocs(collection(db, `elections/${electionId}/positions`));
    if(positionsSnap.empty){
      container.innerHTML = "<p>No positions found for this election.</p>";
      return;
    }

    for(const posDoc of positionsSnap.docs){
      const pos = posDoc.data();
      const posCard = document.createElement("div");
      posCard.className = "position-card";
      posCard.innerHTML = `<h3>${pos.title} (${pos.department})</h3>`;
      container.appendChild(posCard);

      const candidatesSnap = await getDocs(collection(db, `elections/${electionId}/positions/${posDoc.id}/candidates`));
      if(candidatesSnap.empty){
        const p = document.createElement("p");
        p.textContent = "No candidates.";
        posCard.appendChild(p);
      } else {
        candidatesSnap.forEach(cDoc=>{
          const c = cDoc.data();
          const card = document.createElement("div");
          card.className = "candidate-card";
          card.innerHTML = `<span>${c.fullName} (${c.admissionNumber})</span>`;
          const btn = document.createElement("button");

          // Disable if already voted for this position
          if(hasVoted[electionId] && hasVoted[electionId][posDoc.id]){
            btn.textContent = "Voted";
            btn.disabled = true;
          } else {
            btn.textContent = "Vote";
            btn.onclick = ()=> castVote(posDoc.id, cDoc.id);
          }

          card.appendChild(btn);
          posCard.appendChild(card);
        });
      }
    }

  } catch(err){
    console.error(err);
    container.innerHTML = "<p>Error loading candidates.</p>";
  }
}

// Cast vote per position
async function castVote(positionId, candidateId){
  if(!confirm("Are you sure you want to vote for this candidate?")) return;

  try{
    const studentRef = doc(db, "Students", studentDocId);
    const studentSnap = await getDoc(studentRef);
    const student = studentSnap.data();
    const hasVoted = student.hasVoted || {};

    // Already voted check
    if(hasVoted[electionId] && hasVoted[electionId][positionId]){
      alert("You have already voted for this position.");
      return;
    }

    // Increment candidate votes
    const candidateRef = doc(db, `elections/${electionId}/positions/${positionId}/candidates/${candidateId}`);
    const candidateSnap = await getDoc(candidateRef);
    const candidateData = candidateSnap.data();
    const currentVotes = candidateData.votes || 0;
    const votedBy = candidateData.votedBy || [];

    await updateDoc(candidateRef, { 
      votes: currentVotes + 1,
      votedBy: [...votedBy, studentDocId]
    });

    // Update student's voted positions
    const newHasVoted = {...hasVoted};
    if(!newHasVoted[electionId]) newHasVoted[electionId] = {};
    newHasVoted[electionId][positionId] = true;
    await updateDoc(studentRef, { hasVoted: newHasVoted });

    alert("Vote submitted successfully!");
    loadCandidates(); // refresh buttons

  } catch(err){
    console.error(err);
    alert("Error submitting vote.");
  }
}

loadCandidates();
</script>

</body>
</html>
